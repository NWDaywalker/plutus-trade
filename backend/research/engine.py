"""
Deep Research Engine for Polymarket
"""
import json, sqlite3, hashlib, os, re
from datetime import datetime, timezone, timedelta
from dataclasses import dataclass, field, asdict
from typing import List, Dict, Optional, Literal
from enum import Enum

class Category(str, Enum):
    POLITICS = "politics"
        SPORTS = "sports"
            CRYPTO = "crypto"
                ENTERTAINMENT = "entertainment"

                class SourceType(str, Enum):
                    REDDIT = "reddit"
                        TWITTER = "twitter"
                            NEWS = "news"
                                PREDICTION_MARKET = "prediction_market"

                                @dataclass
                                class ResearchItem:
                                        id: str
                                            source_type: SourceType
                                                source_name: str
                                                    category: Category
                                                        title: str
                                                            content: str
                                                                url: str
                                                                    author: str
                                                                        timestamp: str
                                                                            upvotes: int = 0
                                                                                comments: int = 0
                                                                                    engagement_score: float = 0.0
                                                                                        sentiment: float = 0.0
                                                                                            keywords: List[str] = field(default_factory=list)
                                                                                                raw_data: Dict = field(default_factory=dict)
                                                                                                    def to_dict(self):
                                                                                                            d = asdict(self)
                                                                                                                    d['source_type'] = self.source_type.value
                                                                                                                            d['category'] = self.category.value
                                                                                                                                    return d

                                                                                                                                    @dataclass
                                                                                                                                    class MarketSignal:
                                                                                                                                        id: str
                                                                                                                                            market_id: str
                                                                                                                                                market_question: str
                                                                                                                                                    category: Category
                                                                                                                                                        side: Literal["YES", "NO"]
                                                                                                                                                            sentiment_score: float
                                                                                                                                                                confidence: float
                                                                                                                                                                    datapoints: List[Dict]
                                                                                                                                                                        sources_count: int
                                                                                                                                                                            total_engagement: int
                                                                                                                                                                                generated_at: str
                                                                                                                                                                                    expires_at: str
                                                                                                                                                                                        reasoning: str
                                                                                                                                                                                            def to_dict(self):
                                                                                                                                                                                                    d = asdict(self)
                                                                                                                                                                                                            d['category'] = self.category.value
                                                                                                                                                                                                                    return d

                                                                                                                                                                                                                    class ResearchDatabase:
                                                                                                                                                                                                                        def __init__(self, db_path: str = "data/research.db"):
                                                                                                                                                                                                                                self.db_path = db_path
                                                                                                                                                                                                                                        os.makedirs(os.path.dirname(db_path), exist_ok=True)
                                                                                                                                                                                                                                                self._init_db()
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                        def _init_db(self):
                                                                                                                                                                                                                                                                conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                        c = conn.cursor()
                                                                                                                                                                                                                                                                                c.execute('''CREATE TABLE IF NOT EXISTS research_items (
                                                                                                                                                                                                                                                                                            id TEXT PRIMARY KEY, source_type TEXT, source_name TEXT, category TEXT,
                                                                                                                                                                                                                                                                                                        title TEXT, content TEXT, url TEXT, author TEXT, timestamp TEXT,
                                                                                                                                                                                                                                                                                                                    upvotes INTEGER, comments INTEGER, engagement_score REAL, sentiment REAL,
                                                                                                                                                                                                                                                                                                                                keywords TEXT, raw_data TEXT, created_at TEXT)''')
                                                                                                                                                                                                                                                                                                                                        c.execute('''CREATE TABLE IF NOT EXISTS market_signals (
                                                                                                                                                                                                                                                                                                                                                    id TEXT PRIMARY KEY, market_id TEXT, market_question TEXT, category TEXT,
                                                                                                                                                                                                                                                                                                                                                                side TEXT, sentiment_score REAL, confidence REAL, datapoints TEXT,
                                                                                                                                                                                                                                                                                                                                                                            sources_count INTEGER, total_engagement INTEGER, generated_at TEXT,
                                                                                                                                                                                                                                                                                                                                                                                        expires_at TEXT, reasoning TEXT, status TEXT DEFAULT 'active')''')
                                                                                                                                                                                                                                                                                                                                                                                                c.execute('CREATE INDEX IF NOT EXISTS idx_cat ON research_items(category)')
                                                                                                                                                                                                                                                                                                                                                                                                        conn.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                        def store_research_item(self, item: ResearchItem):
                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                            c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                    c.execute('INSERT OR REPLACE INTO research_items VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                (item.id, item.source_type.value, item.source_name, item.category.value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             item.title, item.content, item.url, item.author, item.timestamp,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          item.upvotes, item.comments, item.engagement_score, item.sentiment,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       json.dumps(item.keywords), json.dumps(item.raw_data),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    datetime.now(timezone.utc).isoformat()))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def store_signal(self, signal: MarketSignal):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        c.execute('INSERT OR REPLACE INTO market_signals VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (signal.id, signal.market_id, signal.market_question, signal.category.value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 signal.side, signal.sentiment_score, signal.confidence,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              json.dumps(signal.datapoints), signal.sources_count, signal.total_engagement,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           signal.generated_at, signal.expires_at, signal.reasoning, """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Deep Research Engine for Polymarket
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           import json, sqlite3, hashlib, os, re
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           from datetime import datetime, timezone, timedelta
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           from dataclasses import dataclass, field, asdict
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           from typing import List, Dict, Optional, Literal
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           from enum import Enum
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           class Category(str, Enum):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               POLITICS = "politics"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   SPORTS = "sports"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       CRYPTO = "crypto"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ENTERTAINMENT = "entertainment"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           class SourceType(str, Enum):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               REDDIT = "reddit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TWITTER = "twitter"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       NEWS = "news"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           PREDICTION_MARKET = "prediction_market"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @dataclass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           class ResearchItem:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               id: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   source_type: SourceType
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       source_name: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           category: Category
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               title: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   content: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       url: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           author: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               timestamp: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   upvotes: int = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       comments: int = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           engagement_score: float = 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sentiment: float = 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   keywords: List[str] = field(default_factory=list)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       raw_data: Dict = field(default_factory=dict)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           def to_dict(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   d = asdict(self)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           d['source_type'] = self.source_type.value
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   d['category'] = self.category.value
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return d
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @dataclass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           class MarketSignal:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               id: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   market_id: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       market_question: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           category: Category
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               side: Literal["YES", "NO"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   sentiment_score: float
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       confidence: float
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           datapoints: List[Dict]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sources_count: int
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   total_engagement: int
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       generated_at: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           expires_at: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               reasoning: str
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def to_dict(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           d = asdict(self)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   d['category'] = self.category.value
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return d
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           class ResearchDatabase:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def __init__(self, db_path: str = "data/research.db"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       self.db_path = db_path
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               os.makedirs(os.path.dirname(db_path), exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       self._init_db()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def _init_db(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c.execute('''CREATE TABLE IF NOT EXISTS research_items (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   id TEXT PRIMARY KEY, source_type TEXT, source_name TEXT, category TEXT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               title TEXT, content TEXT, url TEXT, author TEXT, timestamp TEXT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           upvotes INTEGER, comments INTEGER, engagement_score REAL, sentiment REAL,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       keywords TEXT, raw_data TEXT, created_at TEXT)''')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c.execute('''CREATE TABLE IF NOT EXISTS market_signals (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           id TEXT PRIMARY KEY, market_id TEXT, market_question TEXT, category TEXT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       side TEXT, sentiment_score REAL, confidence REAL, datapoints TEXT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   sources_count INTEGER, total_engagement INTEGER, generated_at TEXT,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               expires_at TEXT, reasoning TEXT, status TEXT DEFAULT 'active')''')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c.execute('CREATE INDEX IF NOT EXISTS idx_cat ON research_items(category)')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               conn.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def store_research_item(self, item: ResearchItem):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c.execute('INSERT OR REPLACE INTO research_items VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (item.id, item.source_type.value, item.source_name, item.category.value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                item.title, item.content, item.url, item.author, item.timestamp,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             item.upvotes, item.comments, item.engagement_score, item.sentiment,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          json.dumps(item.keywords), json.dumps(item.raw_data),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       datetime.now(timezone.utc).isoformat()))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               conn.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def store_signal(self, signal: MarketSignal):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c.execute('INSERT OR REPLACE INTO market_signals VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (signal.id, signal.market_id, signal.market_question, signal.category.value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                signal.side, signal.sentiment_score, signal.confidence,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             json.dumps(signal.datapoints), signal.sources_count, signal.total_engagement,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          signal.generated_at, signal.expires_at, signal.reasoning, 'active'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  conn.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def get_recent_research(self, category=None, hours=24, limit=100):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  conn.row_factory = sqlite3.Row
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  cutoff = (datetime.now(timezone.utc) - timedelta(hours=hours)).isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if category:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      c.execute('SELECT * FROM research_items WHERE category=? AND created_at>? ORDER BY engagement_score DESC LIMIT ?',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (category.value, cutoff, limit))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c.execute('SELECT * FROM research_items WHERE created_at>? ORDER BY engagement_score DESC LIMIT ?', (cutoff, limit))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rows = c.fetchall()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               conn.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return [dict(row) for row in rows]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def get_active_signals(self, category=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       conn = sqlite3.connect(self.db_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               conn.row_factory = sqlite3.Row
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               now = datetime.now(timezone.utc).isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if category:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   c.execute("SELECT * FROM market_signals WHERE category=? AND status='active' AND expires_at>? ORDER BY confidence DESC",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (category.value, now))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            c.execute("SELECT * FROM market_signals WHERE status='active' AND expires_at>? ORDER)